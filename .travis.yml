language: cpp

git:
  depth: false

matrix:
  include:
  - os: osx
    env: [ 'PATH=/usr/local/opt/qt/bin:$PATH"', 'DEPLOY_DIR="deploy"' ]
    addons:
      homebrew:
        update: true
        packages:
        - qt5
        - qtkeychain
        - cmark
        - cmake

install:
- git submodule update --init --recursive
- pushd include/libQuotient/3rdparty/libQtOlm
- git clone https://gitlab.matrix.org/matrix-org/olm.git
- popd

script:
- mkdir build && pushd build
- cmake .. -LA -DUSE_INTREE_LIBQMC=1 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr -DDEPLOY_VERBOSITY=$DEPLOY_VERBOSITY
- cmake --build . --target all
- export DESTDIR=$TRAVIS_BUILD_DIR/install
- popd
- macdeployqt build/spectral.app -dmg -qmldir=qml -qmldir=imports

before_deploy:
- mv build/spectral.dmg ./
- sed -i -e "s/TRAVIS_BUILD_NUMBER/0.0.0.$(git rev-list --count HEAD)/g" .ci/bintray-release.json

deploy:
  - provider: bintray
    file: .ci/bintray-release.json
    user: $BINTRAY_USER
    key: $BINTRAY_TOKEN
    skip_cleanup: true
