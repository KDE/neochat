stages:
  - build
  - deploy

build-flatpak:
  image: registry.gitlab.com/b0/flatpak-kde-docker
  stage: build
  before_script:
    - git submodule update --init --recursive
  script:
    - cd flatpak
    - flatpak-builder --force-clean --ccache --repo=repo build-dir org.eu.encom.spectral.yaml
    - flatpak build-bundle repo spectral.flatpak org.eu.encom.spectral
    - cd ../
  cache:
    key: flatpak
    paths:
    - flatpak/.flatpak-builder
  artifacts:
    paths:
    - flatpak/spectral.flatpak

build-appimage:
  image: registry.gitlab.com/b0/qt-docker
  stage: build
  before_script:
    - git submodule update --init --recursive
  script:
    - mkdir -p ccache
    - export CCACHE_BASEDIR=${CI_PROJECT_DIR}
    - export CCACHE_DIR=${CI_PROJECT_DIR}/ccache
    - /opt/qt512/bin/qt512-env.sh
    - /opt/qt512/bin/qmake CONFIG+=debug CONFIG+=qml_debug CONFIG+=ccache PREFIX=/usr
    - make
    - make INSTALL_ROOT=appdir install
    - /usr/bin/linuxdeployqt-continuous-x86_64.AppImage appdir/usr/share/applications/org.eu.encom.spectral.desktop -appimage -qmldir=qml -qmldir=imports -qmake=/opt/qt512/bin/qmake
  cache:
    key: ccache
    paths:
    - ccache/

  artifacts:
    paths:
    - Spectral*.AppImage
